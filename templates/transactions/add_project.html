{% extends 'base/base.html' %}

{% block title %}Create Product{% endblock title %}

{% block head %}
<style>
    .select2-container {
        width: 100% !important;
    }

    .select2-container .select2-selection--single {
        height: 37px !important;
        padding: 4px;
    }

    .select2-selection__arrow {
        height: 37px !important;
    }
</style>
{% endblock head %}

{% block content %}

<div id="myModal" class="modal fade">
    <div class="modal-dialog modal-confirm">
        <div class="modal-content">
            <div class="modal-header">
                <div class="icon-box">
                    <i class="material-icons">&#xE876;</i>
                </div>				
                <h4 class="modal-title w-100">Awesome!</h4>	
            </div>
            <div class="modal-body">
                <p class="text-center">Your booking has been confirmed. Check your email for details.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success btn-block" data-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>     

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <strong class="card-title">Add Project Plan</strong>
            </div>
            <div class="card-body">
                <div id="pay-invoice">
                    <div class="card-body">
                        <form action="#" id="submitform" method="post" enctype="multipart/form-data">
                            {% csrf_token %}

                            <div class="form-group">
                                <label for="name" class="control-label mb-1">Customer Name</label>
                                {{ form.customer }}
                            </div>

                            <div class="form-group">
                                <label for="name" class="control-label mb-1">Purchase Order No </label>
                                {{ form.order_id }}
                            </div>

                            <div class="form-group">
                                <label for="name" class="control-label mb-1">Description </label>
                                {{ form.description }}
                            </div>

                            <div class="form-group">
                                <label for="name" class="control-label mb-1">RRA Invoice No</label>
                                {{ form.rra_invoice_no }}
                            </div>

                            <div class="form-group">
                                <label for="name" class="control-label mb-1">Date</label>
                                {{ form.DC_date }}
                            </div>

                            <hr>
                            <label for="name" class="control-label mb-1">Item Code Details</label>

                            <table id="item-table" class="table">
                                <thead>
                                    <tr>
                                        <th>Item Code</th>
                                        <th>Quantity</th>
                                        <th>
                                            <button type="button" class="btn btn-success add-item">+</button>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="item-row">
                                        <td>
                                            <select class="form-control item-select select2" name="item_code" style="width: 100%">
                                                <option value="">Select Item Code</option>
                                                {% for y in item_code_data %}
                                                    <option value="{{ y.id }}">{{ y }}</option>
                                                {% endfor %}
                                            </select><input type="hidden" name="production_id" value=""> 
                                        </td>
                                        <td>
                                            <input type="number" class="form-control qty-input" name="production_quantity" min="1" value="1" style="width: 50%">
                                        </td>
                                        <td>
                                            <button type="button" class="btn btn-danger remove-item">-</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <!-- Hidden Template -->
                            <table class="d-none">
                                <tr id="item-template" class="item-row">
                                    <td>
                                        <select class="form-control item-select select2" placeholder="Select Item Code" name="item_code" style="width: 100%">
                                            <option value="">Select Item Code</option>
                                            {% for y in item_code_data %}
                                                <option value="{{ y.id }}">{{ y }}</option>
                                            {% endfor %}
                                        </select><input type="hidden" name="production_id" value=""> 
                                    </td>
                                    <td>
                                        <input type="number" class="form-control qty-input" name="production_quantity" min="1" value="1" style="width: 50%">
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-danger remove-item">-</button>
                                    </td>
                                </tr>
                            </table>

                            <br>
                            <div>
                                <button id="payment-button" type="submit" class="btn btn-lg btn-info btn-block">
                                    <span id="payment-button-amount">Add Project</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block js %}
<!-- Select2 CDN -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    function initializeSelect2OnRow(row) {
        row.find('select.select2').select2();
    }

    $(document).ready(function() {
    $('.select2').select2();  // this activates all elements with class="select2"
});


    $('.add-item').on('click', function () {
    const template = $('#item-template').clone();

    // Remove ID and hidden class
    template.removeAttr('id').removeClass('d-none');

    // Remove existing Select2 if any
    template.find('select.select2').each(function () {
        if ($(this).hasClass('select2-hidden-accessible')) {
            $(this).select2('destroy');
        }

        // Remove any Select2 containers that might've been cloned
        $(this).siblings('.select2').remove();
    });

    // Clear values
    template.find('select').val(null);
    template.find('input').val('');

    // Append to table
    $('#item-table tbody').append(template);

    // Initialize select2 on the new rowâ€™s select
    template.find('select.select2').select2({
        width: '100%',
        placeholder: 'Select Item Code',
        allowClear: true
    });
});





        // Remove item row
        $('#item-table').on('click', '.remove-item', function () {
            const row = $(this).closest('tr');
            if ($('#item-table tbody tr').length > 1) {
                row.remove();
            }
        });

        // Form validation
        $("#submitform").on("submit", function (e) {
            const invalidFields = $(this).find("select[required]:enabled").filter(function () {
                return !$(this).val();
            });

            if (invalidFields.length > 0) {
                alert("Please fill in all required fields.");
                return false;
            }
        });

        // Password verification (if used elsewhere)
        window.password_verify = function () {
            const password = document.getElementById('password').value;
            const employee_name = document.getElementById('employee_name').value;

            $.ajax({
                url: "{% url 'verify_password' %}",
                method: 'POST',
                data: {
                    'employee': employee_name,
                    'password': password,
                    'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
                },
                success: function (response) {
                    if (response.status === "done") {
                        document.getElementById('password').disabled = true;
                        document.getElementById('employee_name').disabled = true;
                        alert('Password verification done');
                    } else {
                        alert('Wrong password');
                    }
                },
                error: function (error) {
                    console.log(error);
                }
            });
        };
</script>
{% endblock js %}
