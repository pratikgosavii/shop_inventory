<!DOCTYPE html>
<html>
<head>
    <title>QR Code Scanner</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        #scanner-container {
            width: 100%;
            max-width: 500px;
            text-align: center;
        }
        #scanner-video {
            width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
  <form method="post">
    {% csrf_token %}
    <div id="scanner-container">
        <video id="scanner-video"></video>
    </div>
    </form>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    <script>

        const scannerContainer = document.getElementById('scanner-container');
const scannerVideo = document.getElementById('scanner-video');

Instascan.Camera.getCameras().then(function (cameras) {

    if (cameras.length > 1) {

        const scanner = new Instascan.Scanner({ video: scannerVideo });
            scanner.addListener('scan', function (content) {
                console.log('Scanned:', content);
                scanner.stop(); 
                $.ajax({
                    type: "POST",
                    url: '{% url "assign_values_to_qr_page" %}',
                    data: {
                        'scanned_value': content,
                        'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
                    },
                    success: function (data) {
                        console.log(data.value)
                        if (data.status === "success") { // Fix the comparison operator
                            const redirectUrl = data.redirect_url;
                            console.log('Received redirect URL:', redirectUrl);
                            window.location.href = redirectUrl;
                        }
                    }
                });

            });
            scanner.start(backCamera); // Start the back camera
    }
    else if (cameras.length > 0) {
        // Find the back camera (usually the last one in the list)
        const backCamera = cameras.find(camera => camera.name.toLowerCase().includes('back'));

        if (backCamera) {
            const scanner = new Instascan.Scanner({ video: scannerVideo });
            scanner.addListener('scan', function (content) {
                console.log('Scanned:', content);
                scanner.stop(); 
                $.ajax({
                    type: "POST",
                    url: '{% url "assign_values_to_qr_page" %}',
                    data: {
                        'scanned_value': content,
                        'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
                    },
                    success: function (data) {
                        console.log(data.value)
                        if (data.status === "success") { // Fix the comparison operator
                            const redirectUrl = data.redirect_url;
                            console.log('Received redirect URL:', redirectUrl);
                            window.location.href = redirectUrl;
                        }
                    }
                });

            });
            scanner.start(backCamera); // Start the back camera
        } else {
            console.error('Back camera not found.');
        }
    } else {
        console.error('No cameras found.');
    }
});









    </script>
</body>
</html>
