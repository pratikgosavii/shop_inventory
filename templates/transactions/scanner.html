<!DOCTYPE html>
<html>
<head>
    <title>QR Code Scanner</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        #scanner-container {
            width: 100%;
            max-width: 500px;
            text-align: center;
        }
        #scanner-video {
            width: 100%;
            height: auto;
        }
        #canvas-container {
            display: none; /* Hide the canvas container initially */
        }
    </style>
</head>
<body>
  <form method="post">
    {% csrf_token %}
    <div id="scanner-container">
        <video id="scanner-video"></video>
    </div>
  </form>
  
  <!-- Add a canvas element for rendering the flipped video feed -->
  <div id="canvas-container">
    <canvas id="video-canvas"></canvas>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
  <script>
    const scannerContainer = document.getElementById('scanner-container');
    const scannerVideo = document.getElementById('scanner-video');
    const canvasContainer = document.getElementById('canvas-container');
    const videoCanvas = document.getElementById('video-canvas');
    const ctx = videoCanvas.getContext('2d');

    Instascan.Camera.getCameras().then(function (cameras) {
        if (cameras.length > 0) {
            const scanner = new Instascan.Scanner({ video: scannerVideo });
            scanner.addListener('scan', function (content) {
                console.log('Scanned:', content);
                scanner.stop(); 
                $.ajax({
                  type: "POST",
                  url: '{% url "assign_values_to_qr_page" %}',
                  data: {
                      'scanned_value': content,
                      'csrfmiddlewaretoken':$('input[name=csrfmiddlewaretoken]').val(),
                  },
                  success: function (data) {
                      console.log(data.value)
                      if(data.status === "success"){ // Use === for comparison
                        const redirectUrl = data.redirect_url;
                        console.log('Received redirect URL:', redirectUrl);
                        
                        // Redirect the user to the received URL
                        window.location.href = redirectUrl;
                      }
                  }
              });

            });

            const backCamera = cameras.find(camera => camera.name.toLowerCase().includes('back'));
            scanner.start(backCamera);

            // Flip the canvas horizontally
            videoCanvas.width = scannerVideo.videoWidth;
            videoCanvas.height = scannerVideo.videoHeight;
            ctx.translate(videoCanvas.width, 0);
            ctx.scale(-1, 1);

            // Continuously draw the flipped video feed to the canvas
            function drawVideoToCanvas() {
              ctx.drawImage(scannerVideo, 0, 0, videoCanvas.width, videoCanvas.height);
              requestAnimationFrame(drawVideoToCanvas);
            }
            
            drawVideoToCanvas();
            canvasContainer.style.display = 'block'; // Display the canvas container
        } else {
            console.error('No cameras found.');
        }
    });
  </script>
</body>
</html>
