<!DOCTYPE html>
<html>
<head>
    <title>QR Code Scanner</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        #scanner-container {
            width: 100%;
            max-width: 500px;
            text-align: center;
        }
        #scanner-video {
            width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
  <form method="post">
    {% csrf_token %}
    <div id="scanner-container">
        <video id="camera-preview"></video>
    </div>
    </form>

    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
<script>
const videoElement = document.getElementById('camera-preview');

if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    const constraints = {
        video: { facingMode: { exact: 'environment' } } // Try to use the back camera
    };

    navigator.mediaDevices.getUserMedia(constraints)
        .then(function(stream) {
            videoElement.srcObject = stream;
            videoElement.play();

            const scanner = new Instascan.Scanner({ video: videoElement });
            scanner.addListener('scan', function(content) {
                content = content || '1';
                console.log('Scanned:', content);
                scanner.stop();

                // Corrected AJAX request URL and data
                $.ajax({
                    type: "GET",
                    url: "{% url 'assign_values_to_qr' 0 %}".replace('0', encodeURIComponent(content)),
                    data: {
                        'content': content,
                        'csrfmiddlewaretoken': $('input[name=csrfmiddlewaretoken]').val(),
                    },
                    success: function (data) {
                        console.log(data.value);
                        if (data.status === "success") {
                            const redirectUrl = data.redirect_url;
                            console.log('Received redirect URL:', redirectUrl);
                            window.location.href = redirectUrl;
                        }
                    }
                });
            });

            Instascan.Camera.getCameras().then(function(cameras) {
                if (cameras.length > 0) {
                    const backCamera = cameras.find(camera => camera.name.toLowerCase().includes('back'));

                    if (backCamera) {
                        scanner.start(backCamera);
                    } else {
                        console.error('Back camera not found.');
                    }
                } else {
                    console.error('No cameras found.');
                }
            });
        })
        .catch(function(error) {
            console.error('Error accessing camera:', error);
        });
} else {
    console.error('getUserMedia is not supported.');
}
</script>

</body>
</html>
