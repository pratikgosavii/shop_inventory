{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FCM Example</title>
    <!-- Include Firebase SDK -->

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js'
        import { getMessaging, getToken, onMessage  } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js'

        // Your Firebase project configuration
		const firebaseConfig = {
            apiKey : "AIzaSyBqaqW0SMq8SPHCWX9QKpShGValpYyV2bs" , 
            authDomain : "namasterapidtax-a92e7.firebaseapp.com" , 
            projectId : "namasterapidtax-a92e7" , 
            storageBucket : "namasterapidtax-a92e7.appspot.com" , 
            messagingSenderId : "1072169977465" , 
            appId : "1:1072169977465:web:7b63186ed7f120943b76a8" , 
            measurementId : "G-VTWK2QSFXM" 
		};
		
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        console.log(app)
        // Get FCM token on page load
        document.addEventListener('DOMContentLoaded', function () {
            const messaging = getMessaging(app);


            // Retrieve Firebase Messaging object.
        
            // Specify the path to the service worker script
          
           

        


            function isTokenSentToServer() {
                return window.localStorage.getItem("sentToServer") === "1";
            }
        
            function setTokenSentToServer(sent) {
                if (sent) {
                    window.localStorage.setItem("sentToServer", "1");
                } else {
                    window.localStorage.setItem("sentToServer", "0");
                }
            }
        
        
            function requestPermission() {
                messaging.requestPermission().then(function () {
                    console.log("Has permission!");
                    resetUI();
                }).catch(function (err) {
                    console.log('Unable to get permission to notify.', err);
                });
            }
        
            function resetUI() {
                console.log("In reset ui");
                messaging.getToken().then(function (currentToken) {
                    console.log(currentToken);
                    if (currentToken) {
                        sendTokenToServer(currentToken);
                    } else {
                        setTokenSentToServer(false);
                    }
                }).catch(function (err) {
                    console.log(err);
                    setTokenSentToServer(false);
                });
            }
        
            messaging.onTokenRefresh(function () {
                messaging.getToken().then(function (refreshedToken) {
                    console.log("Token refreshed.");
                    // Indicate that the new Instance ID token has not yet been sent to the
                    // app server.
                    setTokenSentToServer(false);
                    // Send Instance ID token to app server.
                    sendTokenToServer(refreshedToken);
                    resetUI();
                }).catch(function (err) {
                    console.log("Unable to retrieve refreshed token ", err);
                });
            });
        
            messaging.onMessage(function (payload) {
                payload = payload.data;
                // Create notification manually when user is focused on the tab
                const notificationTitle = payload.title;
                const notificationOptions = {
                    body: payload.body,
                    icon: payload.icon_url,
                };
        
                if (!("Notification" in window)) {
                    console.log("This browser does not support system notifications");
                }
                // Let's check whether notification permissions have already been granted
                else if (Notification.permission === "granted") {
                    // If it's okay let's create a notification
                    var notification = new Notification(notificationTitle, notificationOptions);
                    notification.onclick = function (event) {
                        event.preventDefault(); // prevent the browser from focusing the Notification's tab
                        window.open(payload.url, '_blank');
                        notification.close();
                    }
                }
            });
        
        
            requestPermission();

        });

    </script>
</head>

<body>
    <h1>FCM Example</h1>
    <p>FCM Token: <span id="token"></span></p>
</body>

</html>